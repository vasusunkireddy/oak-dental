<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAK Dental Hospital - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }
        h1, h2, h3 {
            font-family: 'Poppins', sans-serif;
        }
        .btn {
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        input, select, textarea {
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            ring: 2px solid #2563eb;
        }
        .toggle-link {
            cursor: pointer;
            color: #2563eb;
        }
        .toggle-link:hover {
            text-decoration: underline;
        }
        .form-container {
            transition: transform 0.5s ease, opacity 0.5s ease;
        }
        .form-hidden {
            transform: translateX(100%);
            opacity: 0;
            position: absolute;
            width: 100%;
        }
        .form-visible {
            transform: translateX(0);
            opacity: 1;
        }
        .alert {
            transition: opacity 0.3s ease;
        }
        .section-panel {
            transition: max-height 0.3s ease;
            overflow: hidden;
        }
        .section-panel.collapsed {
            max-height: 3rem;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #2563eb;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @media (max-width: 768px) {
            .form-container {
                position: static;
            }
            .form-hidden {
                display: none;
            }
            .form-visible {
                display: block;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center flex-wrap">
            <div class="flex items-center">
                <img src="https://i.postimg.cc/50vXRG8K/ram.jpg" alt="OAK Dental Hospital Logo" class="mr-3 w-12 h-12 bg-white rounded-full shadow-sm">
                <h1 class="text-3xl font-extrabold text-gray-800 leading-7">OAK Dental Hospital - Admin</h1>
            </div>
            <div class="flex mt-2 sm:mt-0">
                <a href="/index.html" class="btn bg-blue-700 text-white px-4 py-2 rounded-lg mr-2 hover:bg-blue-800" aria-label="Go to User Page">User Page</a>
                <button onclick="logout()" class="btn bg-red-700 text-white px-4 py-2 rounded-lg hidden" id="logout-btn" aria-label="Logout">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Auth Section -->
    <section id="auth-section" class="py-16">
        <div class="container mx-auto px-4">
            <div class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-md card border border-gray-200 relative overflow-hidden">
                <div id="alert" class="hidden alert bg-blue-100 text-blue-800 p-4 rounded-lg mb-4 flex justify-between items-center">
                    <span id="alert-message"></span>
                    <button onclick="closeAlert()" class="text-blue-800" aria-label="Close alert"><i class="fas fa-times"></i></button>
                </div>
                <!-- Login Form -->
                <div id="login-form-container" class="form-container form-visible">
                    <h2 class="text-2xl font-extrabold mb-6 text-center text-gray-800 leading-7">Admin Login</h2>
                    <form id="login-form" onsubmit="event.preventDefault(); login();">
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2 text-base" for="login-username">Username</label>
                            <input type="text" id="login-username" class="w-full p-4 border rounded-lg shadow-sm text-base" placeholder="Enter username" required aria-required="true" pattern="[A-Za-z0-9]{3,}" title="Username must be at least 3 characters, letters and numbers only">
                        </div>
                        <div class="mb-4 relative">
                            <label class="block text-gray-700 mb-2 text-base" for="login-password">Password</label>
                            <input type="password" id="login-password" class="w-full p-4 border rounded-lg shadow-sm text-base" placeholder="Enter password" required aria-required="true" minlength="6">
                            <button type="button" onclick="togglePassword('login-password')" class="absolute right-4 top-12 text-gray-500" aria-label="Toggle password visibility">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <button type="submit" class="btn w-full bg-blue-700 text-white p-4 rounded-lg hover:bg-blue-800 flex items-center justify-center" aria-label="Login">
                            <span>Login</span>
                            <div class="spinner ml-2" id="login-spinner"></div>
                        </button>
                    </form>
                    <p class="text-center mt-4 text-gray-700 text-base">Don't have an account? <span class="toggle-link" onclick="showRegister()">Register</span></p>
                </div>
                <!-- Register Form -->
                <div id="register-form-container" class="form-container form-hidden">
                    <h2 class="text-2xl font-extrabold mb-6 text-center text-gray-800 leading-7">Admin Registration</h2>
                    <form id="register-form" onsubmit="event.preventDefault(); register();">
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2 text-base" for="register-username">Username</label>
                            <input type="text" id="register-username" class="w-full p-4 border rounded-lg shadow-sm text-base" placeholder="Enter username" required aria-required="true" pattern="[A-Za-z0-9]{3,}" title="Username must be at least 3 characters, letters and numbers only">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2 text-base" for="register-email">Email</label>
                            <input type="email" id="register-email" class="w-full p-4 border rounded-lg shadow-sm text-base" placeholder="Enter email" required aria-required="true">
                        </div>
                        <div class="mb-4 relative">
                            <label class="block text-gray-700 mb-2 text-base" for="register-password">Password</label>
                            <input type="password" id="register-password" class="w-full p-4 border rounded-lg shadow-sm text-base" placeholder="Enter password" required aria-required="true" minlength="6">
                            <button type="button" onclick="togglePassword('register-password')" class="absolute right-4 top-12 text-gray-500" aria-label="Toggle password visibility">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <button type="submit" class="btn w-full bg-blue-700 text-white p-4 rounded-lg hover:bg-blue-800 flex items-center justify-center" aria-label="Register">
                            <span>Register</span>
                            <div class="spinner ml-2" id="register-spinner"></div>
                        </button>
                    </form>
                    <p class="text-center mt-4 text-gray-700 text-base">Already have an account? <span class="toggle-link" onclick="showLogin()">Login</span></p>
                </div>
            </div>
        </div>
    </section>

    <!-- Dashboard Section -->
    <section id="dashboard" class="py-16 hidden">
        <div class="container mx-auto px-4">
            <h2 class="text-4xl font-extrabold text-center mb-4 text-gray-800 leading-7 fade-in" id="welcome-message">Welcome!</h2>
            <h3 class="text-3xl font-extrabold text-center mb-8 text-gray-800 leading-7 fade-in">Admin Dashboard</h3>

            <!-- Manage Appointment Times -->
            <div class="mb-12 section-panel fade-in" id="times-panel">
                <h4 class="text-2xl font-semibold mb-4 text-gray-800 flex justify-between items-center cursor-pointer" onclick="toggleSection('times-panel')">
                    Manage Appointment Times
                    <i class="fas fa-chevron-down"></i>
                </h4>
                <form id="time-form" class="max-w-md mb-6 bg-white p-6 rounded-xl shadow-md card border border-gray-200">
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2 text-base" for="new-time">Add Time Slot</label>
                        <input type="time" id="new-time" class="w-full p-4 border rounded-lg shadow-sm text-base" placeholder="Select time" required aria-required="true">
                    </div>
                    <button type="button" onclick="addTime()" class="btn w-full bg-blue-700 text-white p-4 rounded-lg hover:bg-blue-800 flex items-center justify-center" aria-label="Add Time Slot">
                        <span>Add Time</span>
                        <div class="spinner ml-2" id="time-spinner"></div>
                    </button>
                </form>
                <div id="times-list" class="grid grid-cols-1 sm:grid-cols-3 gap-4"></div>
            </div>

            <!-- Manage Treatments -->
            <div class="mb-12 section-panel fade-in" id="treatments-panel">
                <h4 class="text-2xl font-semibold mb-4 text-gray-800 flex justify-between items-center cursor-pointer" onclick="toggleSection('treatments-panel')">
                    Manage Treatments
                    <i class="fas fa-chevron-down"></i>
                </h4>
                <form id="treatment-form" class="max-w-md mb-6 bg-white p-6 rounded-xl shadow-md card border border-gray-200">
                    <input type="hidden" id="treatment-id">
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2 text-base" for="treatment-name">Treatment Name</label>
                        <input type="text" id="treatment-name" class="w-full p-4 border rounded-lg shadow-sm text-base" placeholder="Enter treatment name" required aria-required="true">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2 text-base" for="treatment-description">Description</label>
                        <textarea id="treatment-description" class="w-full p-4 border rounded-lg shadow-sm text-base" rows="4" placeholder="Enter description" required aria-required="true"></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2 text-base" for="treatment-cost">Cost (₹)</label>
                        <input type="number" id="treatment-cost" class="w-full p-4 border rounded-lg shadow-sm text-base" placeholder="Enter cost" required aria-required="true" min="0">
                    </div>
                    <div class="flex space-x-4">
                        <button type="button" onclick="addTreatment()" class="btn flex-1 bg-blue-700 text-white p-4 rounded-lg hover:bg-blue-800 flex items-center justify-center" id="treatment-submit" aria-label="Add Treatment">
                            <span>Add Treatment</span>
                            <div class="spinner ml-2" id="treatment-spinner"></div>
                        </button>
                        <button type="button" onclick="clearTreatmentForm()" class="btn flex-1 bg-gray-600 text-white p-4 rounded-lg hover:bg-gray-700" aria-label="Clear Form">Clear</button>
                    </div>
                </form>
                <div id="treatments-list" class="grid grid-cols-1 sm:grid-cols-3 gap-4"></div>
            </div>

            <!-- Manage Appointments -->
            <div class="mb-12 section-panel fade-in" id="appointments-panel">
                <h4 class="text-2xl font-semibold mb-4 text-gray-800 flex justify-between items-center cursor-pointer" onclick="toggleSection('appointments-panel')">
                    Manage Appointments
                    <i class="fas fa-chevron-down"></i>
                </h4>
                <div id="appointments-list" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
            </div>

            <!-- Contact Messages -->
            <div class="mb-12 section-panel fade-in" id="contacts-panel">
                <h4 class="text-2xl font-semibold mb-4 text-gray-800 flex justify-between items-center cursor-pointer" onclick="toggleSection('contacts-panel')">
                    Contact Messages
                    <i class="fas fa-chevron-down"></i>
                </h4>
                <div id="contacts-list" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
            </div>

            <!-- Newsletter Subscribers -->
            <div class="section-panel fade-in" id="newsletter-panel">
                <h4 class="text-2xl font-semibold mb-4 text-gray-800 flex justify-between items-center cursor-pointer" onclick="toggleSection('newsletter-panel')">
                    Newsletter Subscribers
                    <i class="fas fa-chevron-down"></i>
                </h4>
                <div id="newsletter-list" class="grid grid-cols-1 sm:grid-cols-3 gap-4"></div>
            </div>
        </div>
    </section>

    <!-- Edit Treatment Modal -->
    <div id="edit-treatment-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-2xl font-extrabold mb-4 text-gray-800 leading-7">Edit Treatment</h3>
            <form id="edit-treatment-form">
                <input type="hidden" id="edit-treatment-id">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2 text-base" for="edit-treatment-name">Treatment Name</label>
                    <input type="text" id="edit-treatment-name" class="w-full p-4 border rounded-lg shadow-sm text-base" placeholder="Enter treatment name" required aria-required="true">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2 text-base" for="edit-treatment-description">Description</label>
                    <textarea id="edit-treatment-description" class="w-full p-4 border rounded-lg shadow-sm text-base" rows="4" placeholder="Enter description" required aria-required="true"></textarea>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2 text-base" for="edit-treatment-cost">Cost (₹)</label>
                    <input type="number" id="edit-treatment-cost" class="w-full p-4 border rounded-lg shadow-sm text-base" placeholder="Enter cost" required aria-required="true" min="0">
                </div>
                <div class="flex space-x-4">
                    <button type="button" onclick="updateTreatment()" class="btn flex-1 bg-blue-700 text-white p-4 rounded-lg hover:bg-blue-800 flex items-center justify-center" aria-label="Update Treatment">
                        <span>Update</span>
                        <div class="spinner ml-2" id="edit-treatment-spinner"></div>
                    </button>
                    <button type="button" onclick="closeModal()" class="btn flex-1 bg-gray-600 text-white p-4 rounded-lg hover:bg-gray-700" aria-label="Cancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';
        let token = localStorage.getItem('adminToken');

        // Decode JWT to get username
        function decodeJWT(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error('Error decoding JWT:', error);
                return null;
            }
        }

        // Initialize Axios with global error handling
        axios.interceptors.response.use(
            response => response,
            error => {
                showAlert(error.response?.data?.message || 'An error occurred. Please try again.', 'error');
                return Promise.reject(error);
            }
        );

        // Check if already logged in
        if (token) {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('logout-btn').classList.remove('hidden');
            const decoded = decodeJWT(token);
            if (decoded && decoded.username) {
                document.getElementById('welcome-message').textContent = `Welcome, ${decoded.username}!`;
            }
            loadDashboard();
        }

        function showRegister() {
            const loginForm = document.getElementById('login-form-container');
            const registerForm = document.getElementById('register-form-container');
            loginForm.classList.remove('form-visible');
            loginForm.classList.add('form-hidden');
            registerForm.classList.remove('form-hidden');
            registerForm.classList.add('form-visible');
            closeAlert();
        }

        function showLogin() {
            const loginForm = document.getElementById('login-form-container');
            const registerForm = document.getElementById('register-form-container');
            registerForm.classList.remove('form-visible');
            registerForm.classList.add('form-hidden');
            loginForm.classList.remove('form-hidden');
            loginForm.classList.add('form-visible');
            closeAlert();
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            const alertMessage = document.getElementById('alert-message');
            alertMessage.textContent = message;
            alert.classList.remove('hidden', 'bg-blue-100', 'bg-red-100', 'text-blue-800', 'text-red-800');
            alert.classList.add(type === 'success' ? 'bg-blue-100' : 'bg-red-100', type === 'success' ? 'text-blue-800' : 'text-red-800');
            setTimeout(closeAlert, 5000);
        }

        function closeAlert() {
            const alert = document.getElementById('alert');
            alert.classList.add('hidden');
        }

        function showSpinner(id) {
            document.getElementById(id).style.display = 'block';
        }

        function hideSpinner(id) {
            document.getElementById(id).style.display = 'none';
        }

        async function register() {
            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;

            if (!username || !email || !password) {
                showAlert('Please fill all fields.', 'error');
                return;
            }

            showSpinner('register-spinner');
            try {
                await axios.post(`${API_URL}/admin/register`, { username, email, password });
                showAlert('Registration successful! Please log in.');
                document.getElementById('register-form').reset();
                showLogin();
            } catch (error) {
                // Error handled by Axios interceptor
            } finally {
                hideSpinner('register-spinner');
            }
        }

        async function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            if (!username || !password) {
                showAlert('Please fill all fields.', 'error');
                return;
            }

            showSpinner('login-spinner');
            try {
                const response = await axios.post(`${API_URL}/admin/login`, { username, password });
                token = response.data.token;
                localStorage.setItem('adminToken', token);
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('logout-btn').classList.remove('hidden');
                const decoded = decodeJWT(token);
                if (decoded && decoded.username) {
                    document.getElementById('welcome-message').textContent = `Welcome, ${decoded.username}!`;
                }
                loadDashboard();
            } catch (error) {
                // Error handled by Axios interceptor
            } finally {
                hideSpinner('login-spinner');
            }
        }

        function logout() {
            localStorage.removeItem('adminToken');
            token = null;
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('logout-btn').classList.add('hidden');
            document.getElementById('login-form').reset();
            document.getElementById('register-form').reset();
            document.getElementById('welcome-message').textContent = 'Welcome!';
            showLogin();
        }

        function toggleSection(panelId) {
            const panel = document.getElementById(panelId);
            const icon = panel.querySelector('i');
            panel.classList.toggle('collapsed');
            icon.classList.toggle('fa-chevron-down');
            icon.classList.toggle('fa-chevron-up');
        }

        async function loadDashboard() {
            showSpinner('dashboard-spinner');
            try {
                const config = { headers: { Authorization: `Bearer ${token}` } };
                const [times, treatments, appointments, contacts, newsletter] = await Promise.all([
                    axios.get(`${API_URL}/admin/times`, config),
                    axios.get(`${API_URL}/admin/treatments`, config),
                    axios.get(`${API_URL}/admin/appointments`, config),
                    axios.get(`${API_URL}/admin/contacts`, config),
                    axios.get(`${API_URL}/admin/newsletter`, config)
                ]);

                // Render Times
                const timesList = document.getElementById('times-list');
                timesList.innerHTML = '';
                times.data.forEach(time => {
                    const div = document.createElement('div');
                    div.className = 'bg-white p-6 rounded-xl shadow-md card border border-gray-200 flex justify-between items-center';
                    div.innerHTML = `
                        <p class="text-gray-700 text-base">${time.time}</p>
                        <button onclick="deleteTime('${time._id}')" class="btn bg-red-700 text-white px-3 py-2 rounded-lg hover:bg-red-800" aria-label="Delete Time Slot">Delete</button>
                    `;
                    timesList.appendChild(div);
                });

                // Render Treatments
                const treatmentsList = document.getElementById('treatments-list');
                treatmentsList.innerHTML = '';
                treatments.data.forEach(treatment => {
                    const div = document.createElement('div');
                    div.className = 'bg-white p-6 rounded-xl shadow-md card border border-gray-200';
                    div.innerHTML = `
                        <h3 class="text-lg font-semibold mb-2 text-gray-800">${treatment.name}</h3>
                        <p class="text-gray-700 mb-2 text-base">${treatment.description}</p>
                        <p class="text-gray-700 font-semibold mb-2 text-base">₹${treatment.cost}</p>
                        <button onclick="editTreatment('${treatment._id}', '${treatment.name}', '${treatment.description}', ${treatment.cost})" class="btn bg-blue-700 text-white px-3 py-2 rounded-lg mr-2 hover:bg-blue-800" aria-label="Edit Treatment">Edit</button>
                        <button onclick="deleteTreatment('${treatment._id}')" class="btn bg-red-700 text-white px-3 py-2 rounded-lg hover:bg-red-800" aria-label="Delete Treatment">Delete</button>
                    `;
                    treatmentsList.appendChild(div);
                });

                // Render Appointments
                const appointmentsList = document.getElementById('appointments-list');
                appointmentsList.innerHTML = '';
                appointments.data.forEach(appointment => {
                    const div = document.createElement('div');
                    div.className = 'bg-white p-6 rounded-xl shadow-md card border border-gray-200';
                    div.innerHTML = `
                        <p class="text-gray-700 text-base"><strong>Name:</strong> ${appointment.name}</p>
                        <p class="text-gray-700 text-base"><strong>Email:</strong> ${appointment.email}</p>
                        <p class="text-gray-700 text-base"><strong>Date:</strong> ${appointment.date}</p>
                        <p class="text-gray-700 text-base"><strong>Time:</strong> ${appointment.time}</p>
                        <p class="text-gray-700 text-base"><strong>Service:</strong> ${appointment.service.name}</p>
                        <p class="text-gray-700 text-base"><strong>Status:</strong> ${appointment.status}</p>
                        <select onchange="updateAppointmentStatus('${appointment._id}', this.value)" class="mt-2 p-2 border rounded-lg text-base" aria-label="Update Appointment Status">
                            <option value="Pending" ${appointment.status === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option value="Confirmed" ${appointment.status === 'Confirmed' ? 'selected' : ''}>Confirmed</option>
                            <option value="Cancelled" ${appointment.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                    `;
                    appointmentsList.appendChild(div);
                });

                // Render Contacts
                const contactsList = document.getElementById('contacts-list');
                contactsList.innerHTML = '';
                contacts.data.forEach(contact => {
                    const div = document.createElement('div');
                    div.className = 'bg-white p-6 rounded-xl shadow-md card border border-gray-200';
                    div.innerHTML = `
                        <p class="text-gray-700 text-base"><strong>Name:</strong> ${contact.name}</p>
                        <p class="text-gray-700 text-base"><strong>Email:</strong> ${contact.email}</p>
                        <p class="text-gray-700 text-base"><strong>Message:</strong> ${contact.message}</p>
                    `;
                    contactsList.appendChild(div);
                });

                // Render Newsletter Subscribers
                const newsletterList = document.getElementById('newsletter-list');
                newsletterList.innerHTML = '';
                newsletter.data.forEach(subscriber => {
                    const div = document.createElement('div');
                    div.className = 'bg-white p-6 rounded-xl shadow-md card border border-gray-200';
                    div.innerHTML = `
                        <p class="text-gray-700 text-base"><strong>Email:</strong> ${subscriber.email}</p>
                    `;
                    newsletterList.appendChild(div);
                });
            } catch (error) {
                showAlert('Failed to load dashboard. Please log in again.', 'error');
                logout();
            } finally {
                hideSpinner('dashboard-spinner');
            }
        }

        async function addTime() {
            const time = document.getElementById('new-time').value;
            if (!time) {
                showAlert('Please enter a time.', 'error');
                return;
            }
            showSpinner('time-spinner');
            try {
                await axios.post(`${API_URL}/admin/times`, { time }, { headers: { Authorization: `Bearer ${token}` } });
                showAlert('Time slot added.');
                document.getElementById('time-form').reset();
                loadDashboard();
            } catch (error) {
                // Error handled by Axios interceptor
            } finally {
                hideSpinner('time-spinner');
            }
        }

        async function deleteTime(id) {
            if (!confirm('Are you sure you want to delete this time slot?')) return;
            showSpinner('time-spinner');
            try {
                await axios.delete(`${API_URL}/admin/times/${id}`, { headers: { Authorization: `Bearer ${token}` } });
                showAlert('Time slot deleted.');
                loadDashboard();
            } catch (error) {
                // Error handled by Axios interceptor
            } finally {
                hideSpinner('time-spinner');
            }
        }

        function editTreatment(id, name, description, cost) {
            document.getElementById('edit-treatment-id').value = id;
            document.getElementById('edit-treatment-name').value = name;
            document.getElementById('edit-treatment-description').value = description;
            document.getElementById('edit-treatment-cost').value = cost;
            document.getElementById('edit-treatment-modal').style.display = 'flex';
        }

        async function updateTreatment() {
            const id = document.getElementById('edit-treatment-id').value;
            const name = document.getElementById('edit-treatment-name').value;
            const description = document.getElementById('edit-treatment-description').value;
            const cost = document.getElementById('edit-treatment-cost').value;

            if (!name || !description || !cost) {
                showAlert('Please fill all fields.', 'error');
                return;
            }

            showSpinner('edit-treatment-spinner');
            try {
                await axios.put(`${API_URL}/admin/treatments/${id}`, { name, description, cost }, { headers: { Authorization: `Bearer ${token}` } });
                showAlert('Treatment updated.');
                closeModal();
                loadDashboard();
            } catch (error) {
                // Error handled by Axios interceptor
            } finally {
                hideSpinner('edit-treatment-spinner');
            }
        }

        function closeModal() {
            document.getElementById('edit-treatment-modal').style.display = 'none';
            document.getElementById('edit-treatment-form').reset();
        }

        async function addTreatment() {
            const id = document.getElementById('treatment-id').value;
            const name = document.getElementById('treatment-name').value;
            const description = document.getElementById('treatment-description').value;
            const cost = document.getElementById('treatment-cost').value;

            if (!name || !description || !cost) {
                showAlert('Please fill all fields.', 'error');
                return;
            }

            showSpinner('treatment-spinner');
            try {
                const config = { headers: { Authorization: `Bearer ${token}` } };
                if (id) {
                    await axios.put(`${API_URL}/admin/treatments/${id}`, { name, description, cost }, config);
                    showAlert('Treatment updated.');
                } else {
                    await axios.post(`${API_URL}/admin/treatments`, { name, description, cost }, config);
                    showAlert('Treatment added.');
                }
                clearTreatmentForm();
                loadDashboard();
            } catch (error) {
                // Error handled by Axios interceptor
            } finally {
                hideSpinner('treatment-spinner');
            }
        }

        function clearTreatmentForm() {
            document.getElementById('treatment-form').reset();
            document.getElementById('treatment-id').value = '';
            document.getElementById('treatment-submit').textContent = 'Add Treatment';
            document.getElementById('treatment-submit').setAttribute('aria-label', 'Add Treatment');
        }

        async function deleteTreatment(id) {
            if (!confirm('Are you sure you want to delete this treatment?')) return;
            showSpinner('treatment-spinner');
            try {
                await axios.delete(`${API_URL}/admin/treatments/${id}`, { headers: { Authorization: `Bearer ${token}` } });
                showAlert('Treatment deleted.');
                loadDashboard();
            } catch (error) {
                // Error handled by Axios interceptor
            } finally {
                hideSpinner('treatment-spinner');
            }
        }

        async function updateAppointmentStatus(id, status) {
            showSpinner('appointment-spinner');
            try {
                await axios.put(`${API_URL}/admin/appointments/${id}`, { status }, { headers: { Authorization: `Bearer ${token}` } });
                showAlert('Appointment status updated.');
                loadDashboard();
            } catch (error) {
                // Error handled by Axios interceptor
            } finally {
                hideSpinner('appointment-spinner');
            }
        }

        // Initialize dashboard spinner (not rendered in DOM)
        document.addEventListener('DOMContentLoaded', () => {
            const spinner = document.createElement('div');
            spinner.id = 'dashboard-spinner';
            spinner.className = 'spinner';
            document.body.appendChild(spinner);
        });
    </script>
</body>
</html>