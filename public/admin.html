<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oak Dental Hospital - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #e5e7eb;
            margin: 0;
        }
        .header {
            background-color: #1e3a8a;
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .nav-links a {
            color: white;
            padding: 0.5rem 1rem;
            margin: 0 0.25rem;
            transition: background-color 0.3s ease;
        }
        .nav-links a:hover {
            background-color: #3b82f6;
            border-radius: 0.25rem;
        }
        .section {
            background: white;
            padding: 1.5rem;
            margin: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            border: 1px solid #d1d5db;
            padding: 0.75rem;
            text-align: left;
        }
        th {
            background-color: #f3f4f6;
            font-weight: bold;
            color: #374151;
        }
        td {
            color: #4b5563;
        }
        input, select, textarea {
            border: 1px solid #d1d5db;
            padding: 0.5rem;
            border-radius: 0.25rem;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #3b82f6;
            outline: none;
        }
        button {
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            transition: background-color 0.3s ease;
        }
        .btn-primary {
            background-color: #1e40af;
            color: white;
        }
        .btn-primary:hover {
            background-color: #3b82f6;
        }
        .btn-success {
            background-color: #22c55e;
            color: white;
        }
        .btn-success:hover {
            background-color: #16a34a;
        }
        .btn-danger {
            background-color: #dc2626;
            color: white;
        }
        .btn-danger:hover {
            background-color: #ef4444;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #9ca3af;
        }
        @media (max-width: 768px) {
            .header {
                padding: 0.75rem;
            }
            .nav-links a {
                padding: 0.5rem;
                margin: 0;
            }
            .section {
                margin: 0.5rem;
                padding: 1rem;
            }
            th, td {
                padding: 0.5rem;
                font-size: 0.875rem;
            }
            button {
                width: 100%;
                margin-top: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <nav class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <img src="https://i.postimg.cc/50vXRG8K/ram.jpg" alt="Oak Dental Logo" class="h-10 w-10 rounded-full">
                <div>
                    <h1 class="text-lg font-bold">Oak Dental Hospital - Admin</h1>
                    <p class="text-sm">A Multi-Speciality & Implant Center</p>
                </div>
            </div>
            <div id="nav-links" class="nav-links hidden md:flex space-x-1">
                <a href="#login" id="nav-login">Login</a>
                <a href="#register" id="nav-register">Register</a>
                <a href="#appointments" id="nav-appointments" class="manage-section hidden">Manage Appointments</a>
                <a href="#treatments" id="nav-treatments" class="manage-section hidden">Manage Treatments</a>
                <a href="#timings" id="nav-timings" class="manage-section hidden">Manage Timings</a>
                <a href="/" id="nav-user-page">User Page</a>
                <a href="#" id="logout" class="hidden">Logout</a>
            </div>
            <div class="md:hidden">
                <button id="menu-toggle" class="text-white focus:outline-none">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                    </svg>
                </button>
            </div>
        </nav>
    </header>

    <div class="mobile-nav md:hidden bg-blue-900 text-white p-2 hidden">
        <div class="nav-links flex flex-col space-y-2">
            <a href="#login" id="nav-login-mobile">Login</a>
            <a href="#register" id="nav-register-mobile">Register</a>
            <a href="#appointments" id="nav-appointments-mobile" class="manage-section hidden">Manage Appointments</a>
            <a href="#treatments" id="nav-treatments-mobile" class="manage-section hidden">Manage Treatments</a>
            <a href="#timings" id="nav-timings-mobile" class="manage-section hidden">Manage Timings</a>
            <a href="/" id="nav-user-page-mobile">User Page</a>
            <a href="#" id="logout-mobile" class="hidden">Logout</a>
        </div>
    </div>

    <main class="container mx-auto p-4">
        <section id="login" class="section">
            <h2 class="text-lg font-bold mb-4 text-gray-800">Admin Login</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 mb-1">Username</label>
                    <input type="text" id="login-username" placeholder="Enter username">
                </div>
                <div>
                    <label class="block text-gray-700 mb-1">Password</label>
                    <input type="password" id="login-password" placeholder="Enter password">
                </div>
                <button id="login-btn" class="btn-primary">Login</button>
            </div>
            <p class="mt-2 text-gray-600">New Admin? <a href="#register" class="text-blue-600 hover:underline">Register</a></p>
        </section>

        <section id="register" class="section hidden">
            <h2 class="text-lg font-bold mb-4 text-gray-800">Admin Registration</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 mb-1">Username</label>
                    <input type="text" id="register-username" placeholder="Enter username">
                </div>
                <div>
                    <label class="block text-gray-700 mb-1">Password</label>
                    <input type="password" id="register-password" placeholder="Enter password">
                </div>
                <div>
                    <label class="block text-gray-700 mb-1">Email</label>
                    <input type="email" id="register-email" placeholder="Enter email">
                </div>
                <button id="register-btn" class="btn-primary">Register</button>
            </div>
            <p class="mt-2 text-gray-600">Already registered? <a href="#login" class="text-blue-600 hover:underline">Login</a></p>
        </section>

        <section id="appointments" class="section hidden">
            <h2 class="text-lg font-bold mb-4 text-gray-800">Manage Appointments</h2>
            <div class="overflow-x-auto">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Treatment</th>
                            <th>Fee</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Status</th>
                            <th>Payment ID</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="appointments-table"></tbody>
                </table>
            </div>
        </section>

        <section id="treatments" class="section hidden">
            <h2 class="text-lg font-bold mb-4 text-gray-800">Manage Treatments</h2>
            <div class="mb-6">
                <h3 class="text-md font-semibold mb-2 text-gray-700">Add/Edit Treatment</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 mb-1">Treatment Name</label>
                        <input type="text" id="treatment-name" placeholder="Enter treatment name">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">Description</label>
                        <textarea id="treatment-description" placeholder="Enter description" rows="3"></textarea>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">Price</label>
                        <input type="number" id="treatment-price" placeholder="Enter price">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">Offer (%)</label>
                        <input type="number" id="treatment-offer" placeholder="Enter offer percentage (e.g., 10 for 10%)">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">Photo</label>
                        <input type="file" id="treatment-photo" accept="image/*">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">Video</label>
                        <input type="file" id="treatment-video" accept="video/*">
                    </div>
                    <button id="save-treatment" class="btn-primary">Save Treatment</button>
                    <button id="clear-treatment-form" class="btn-secondary">Clear Form</button>
                </div>
            </div>
            <div>
                <h3 class="text-md font-semibold mb-2 text-gray-700">Current Treatments</h3>
                <div class="overflow-x-auto">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Price</th>
                                <th>Offer</th>
                                <th>Photo</th>
                                <th>Video</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="treatments-table"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="timings" class="section hidden">
            <h2 class="text-lg font-bold mb-4 text-gray-800">Manage Hospital Timings</h2>
            <div class="mb-6">
                <h3 class="text-md font-semibold mb-2 text-gray-700">Update Timings</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 mb-1">Day</label>
                        <select id="timing-day">
                            <option value="Monday">Monday</option>
                            <option value="Tuesday">Tuesday</option>
                            <option value="Wednesday">Wednesday</option>
                            <option value="Thursday">Thursday</option>
                            <option value="Friday">Friday</option>
                            <option value="Saturday">Saturday</option>
                            <option value="Sunday">Sunday</option>
                        </select>
                    </div>
                    <div class="flex space-x-2">
                        <div class="flex-1">
                            <label class="block text-gray-700 mb-1">Open Time</label>
                            <div class="flex space-x-2">
                                <input type="number" id="open-hour" placeholder="Hour (1-12)" min="1" max="12">
                                <input type="number" id="open-minute" placeholder="Minute (0-59)" min="0" max="59">
                                <select id="open-period">
                                    <option value="AM">AM</option>
                                    <option value="PM">PM</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <div class="flex-1">
                            <label class="block text-gray-700 mb-1">Close Time</label>
                            <div class="flex space-x-2">
                                <input type="number" id="close-hour" placeholder="Hour (1-12)" min="1" max="12">
                                <input type="number" id="close-minute" placeholder="Minute (0-59)" min="0" max="59">
                                <select id="close-period">
                                    <option value="AM">AM</option>
                                    <option value="PM">PM</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <button id="update-timing" class="btn-primary">Update Timing</button>
                </div>
            </div>
            <div>
                <h3 class="text-md font-semibold mb-2 text-gray-700">Current Timings</h3>
                <div class="overflow-x-auto">
                    <table>
                        <thead>
                            <tr>
                                <th>Day</th>
                                <th>Open Time</th>
                                <th>Close Time</th>
                            </tr>
                        </thead>
                        <tbody id="timings-table"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <script>
        // Toggle mobile menu
        const menuToggle = document.getElementById('menu-toggle');
        const mobileNav = document.querySelector('.mobile-nav');
        menuToggle.addEventListener('click', () => {
            mobileNav.classList.toggle('hidden');
        });

        // Navigation between sections
        const sections = ['login', 'register', 'appointments', 'treatments', 'timings'];
        function showSection(sectionId) {
            sections.forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
        }

        // Navigation for management sections (after login)
        document.querySelectorAll('.manage-section').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const sectionId = link.getAttribute('href').substring(1);
                if (!localStorage.getItem('token')) {
                    alert('Please log in to access this section.');
                    showSection('login');
                    return;
                }
                showSection(sectionId);
            });
        });

        // Navigation for login/register links
        document.getElementById('nav-login').addEventListener('click', (e) => {
            e.preventDefault();
            showSection('login');
        });
        document.getElementById('nav-register').addEventListener('click', (e) => {
            e.preventDefault();
            showSection('register');
        });
        document.getElementById('nav-login-mobile').addEventListener('click', (e) => {
            e.preventDefault();
            showSection('login');
        });
        document.getElementById('nav-register-mobile').addEventListener('click', (e) => {
            e.preventDefault();
            showSection('register');
        });

        // Show navigation links based on login status
        function updateNavVisibility() {
            const isLoggedIn = !!localStorage.getItem('token');
            const manageSections = document.querySelectorAll('.manage-section');
            const logoutLinks = document.querySelectorAll('#logout, #logout-mobile');
            const loginLinks = document.querySelectorAll('#nav-login, #nav-login-mobile');
            const registerLinks = document.querySelectorAll('#nav-register, #nav-register-mobile');

            if (isLoggedIn) {
                manageSections.forEach(link => link.classList.remove('hidden'));
                logoutLinks.forEach(link => link.classList.remove('hidden'));
                loginLinks.forEach(link => link.classList.add('hidden'));
                registerLinks.forEach(link => link.classList.add('hidden'));
            } else {
                manageSections.forEach(link => link.classList.add('hidden'));
                logoutLinks.forEach(link => link.classList.add('hidden'));
                loginLinks.forEach(link => link.classList.remove('hidden'));
                registerLinks.forEach(link => link.classList.remove('hidden'));
            }

            const mobileNav = document.querySelector('.mobile-nav');
            mobileNav.classList.add('hidden');
        }

        // Handle login
        document.getElementById('login-btn').addEventListener('click', async () => {
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value.trim();
            if (!username || !password) {
                alert('Please enter both username and password.');
                return;
            }
            try {
                const response = await fetch('https://oak-dental.onrender.com/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const result = await response.json();
                if (response.ok) {
                    localStorage.setItem('token', result.token);
                    alert('Login successful!');
                    updateNavVisibility();
                    showSection('appointments');
                    loadAppointments();
                } else {
                    alert(result.message || 'Login failed. Please try again.');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('An error occurred while logging in: ' + error.message);
            }
        });

        // Handle registration
        document.getElementById('register-btn').addEventListener('click', async () => {
            const username = document.getElementById('register-username').value.trim();
            const password = document.getElementById('register-password').value.trim();
            const email = document.getElementById('register-email').value.trim();
            if (!username || !password || !email) {
                alert('Please fill in all fields.');
                return;
            }
            try {
                const response = await fetch('https://oak-dental.onrender.com/api/admin/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, email })
                });
                const result = await response.json();
                if (response.ok) {
                    alert('Registration successful! Please log in.');
                    showSection('login');
                } else {
                    console.error('Registration failed:', result);
                    alert(result.message || 'Registration failed. Please check the console for more details.');
                }
            } catch (error) {
                console.error('Registration error:', error);
                alert('An error occurred while registering: ' + error.message);
            }
        });

        // Logout functionality
        const logoutLinks = [document.getElementById('logout'), document.getElementById('logout-mobile')];
        logoutLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('token');
                updateNavVisibility();
                showSection('login');
                alert('Logged out successfully.');
                window.location.href = '/admin.html';
            });
        });

        // Load appointments (only show if payment is done)
        async function loadAppointments() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Please log in to view appointments.');
                showSection('login');
                return;
            }
            try {
                const response = await fetch('https://oak-dental.onrender.com/api/appointments', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) {
                    throw new Error('Failed to fetch appointments.');
                }
                const appointments = await response.json();
                const tableBody = document.getElementById('appointments-table');
                tableBody.innerHTML = '';
                const paidAppointments = appointments.filter(apt => apt.payment_id && apt.payment_id !== 'Pending');
                if (paidAppointments.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="10" class="text-center">No paid appointments found.</td></tr>';
                    return;
                }
                paidAppointments.forEach(apt => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${apt.full_name || 'N/A'}</td>
                        <td>${apt.phone || 'N/A'}</td>
                        <td>${apt.email || 'N/A'}</td>
                        <td>${apt.treatment || 'N/A'}</td>
                        <td>${apt.price || 'N/A'}</td>
                        <td>${apt.date || 'N/A'}</td>
                        <td>${apt.time || 'N/A'}</td>
                        <td>${apt.status || 'Pending'}</td>
                        <td>${apt.payment_id}</td>
                        <td>
                            <button class="approve-btn btn-success mr-2" data-id="${apt.id}" ${apt.status === 'Approved' || apt.status === 'Rejected' ? 'disabled' : ''}>Approve</button>
                            <button class="reject-btn btn-danger" data-id="${apt.id}" ${apt.status === 'Approved' || apt.status === 'Rejected' ? 'disabled' : ''}>Reject</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                // Add event listeners for approve/reject buttons
                document.querySelectorAll('.approve-btn').forEach(btn => {
                    btn.addEventListener('click', () => handleAppointmentAction(btn.dataset.id, 'Approved'));
                });
                document.querySelectorAll('.reject-btn').forEach(btn => {
                    btn.addEventListener('click', () => handleAppointmentAction(btn.dataset.id, 'Rejected'));
                });
            } catch (error) {
                console.error('Error loading appointments:', error);
                alert('Failed to load appointments: ' + error.message);
            }
        }

        // Handle appointment approval/rejection
        async function handleAppointmentAction(id, action) {
            let reason = '';
            if (action === 'Rejected') {
                reason = prompt('Please provide a reason for rejecting this appointment:');
                if (!reason) {
                    alert('A reason is required to reject the appointment.');
                    return;
                }
            }
            try {
                const response = await fetch(`https://oak-dental.onrender.com/api/appointments/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ status: action, rejection_reason: reason })
                });
                const result = await response.json();
                if (response.ok) {
                    alert(`Appointment ${action.toLowerCase()} successfully.`);
                    const appointment = await fetchAppointmentDetails(id);
                    await sendNotification(appointment, action, reason);
                    loadAppointments();
                } else {
                    alert(result.message || `Failed to ${action.toLowerCase()} appointment.`);
                }
            } catch (error) {
                console.error(`Error ${action.toLowerCase()}ing appointment:`, error);
                alert(`An error occurred while ${action.toLowerCase()}ing the appointment: ` + error.message);
            }
        }

        // Fetch appointment details for notification
        async function fetchAppointmentDetails(id) {
            try {
                const response = await fetch(`https://oak-dental.onrender.com/api/appointments/${id}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                if (!response.ok) {
                    throw new Error('Failed to fetch appointment details.');
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching appointment details:', error);
                throw error;
            }
        }

        // Send email and SMS notification
        async function sendNotification(appointment, action, reason) {
            const emailBody = {
                email: appointment.email,
                subject: `Appointment ${action} - Oak Dental Hospital`,
                message: `Dear ${appointment.full_name},\n\nYour appointment for ${appointment.treatment} on ${appointment.date} at ${appointment.time} has been ${action.toLowerCase()}.\n${action === 'Rejected' ? `Reason: ${reason}\n` : ''}Thank you for choosing Oak Dental Hospital.\n\nBest regards,\nOak Dental Team`
            };
            const smsBody = {
                phone: appointment.phone,
                message: `Your appointment for ${appointment.treatment} on ${appointment.date} at ${appointment.time} has been ${action.toLowerCase()}.${action === 'Rejected' ? ` Reason: ${reason}` : ''} - Oak Dental Hospital`
            };

            try {
                await fetch('https://oak-dental.onrender.com/api/send-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(emailBody)
                });
                await fetch('https://oak-dental.onrender.com/api/send-sms', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(smsBody)
                });
            } catch (error) {
                console.error('Error sending notification:', error);
                alert('Appointment updated, but failed to send notification: ' + error.message);
            }
        }

        // Load treatments
        async function loadTreatments() {
            try {
                const response = await fetch('https://oak-dental.onrender.com/api/treatments');
                if (!response.ok) {
                    throw new Error('Failed to fetch treatments.');
                }
                const treatments = await response.json();
                const tableBody = document.getElementById('treatments-table');
                tableBody.innerHTML = '';
                if (treatments.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No treatments found.</td></tr>';
                    return;
                }
                treatments.forEach(treatment => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${treatment.name || 'N/A'}</td>
                        <td>${treatment.description || 'N/A'}</td>
                        <td>${treatment.price || 'N/A'}</td>
                        <td>${treatment.offer ? treatment.offer + '%' : 'N/A'}</td>
                        <td>${treatment.image_url ? `<img src="${treatment.image_url}" alt="${treatment.name}" class="h-8 w-8 object-cover rounded"/>` : 'N/A'}</td>
                        <td>${treatment.video_url ? `<a href="${treatment.video_url}" class="text-blue-600 hover:underline">View</a>` : 'N/A'}</td>
                        <td>
                            <button class="edit-treatment text-blue-600 hover:underline mr-2" data-id="${treatment.id}">Edit</button>
                            <button class="delete-treatment text-red-600 hover:underline" data-id="${treatment.id}">Delete</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                document.querySelectorAll('.edit-treatment').forEach(btn => {
                    btn.addEventListener('click', () => editTreatment(btn.dataset.id));
                });
                document.querySelectorAll('.delete-treatment').forEach(btn => {
                    btn.addEventListener('click', () => deleteTreatment(btn.dataset.id));
                });
            } catch (error) {
                console.error('Error loading treatments:', error);
                alert('Failed to load treatments: ' + error.message);
            }
        }

        // Save or update treatment
        document.getElementById('save-treatment').addEventListener('click', async () => {
            const name = document.getElementById('treatment-name').value.trim();
            const description = document.getElementById('treatment-description').value.trim();
            const price = document.getElementById('treatment-price').value.trim();
            const offer = document.getElementById('treatment-offer').value.trim();
            const photo = document.getElementById('treatment-photo').files[0];
            const video = document.getElementById('treatment-video').files[0];

            if (!name || !price) {
                alert('Please provide at least the treatment name and price.');
                return;
            }

            const formData = new FormData();
            formData.append('name', name);
            formData.append('description', description);
            formData.append('price', price);
            if (offer) formData.append('offer', offer);
            if (photo) formData.append('image', photo);
            if (video) formData.append('video', video);

            const treatmentId = document.getElementById('save-treatment').dataset.id;
            const url = treatmentId ? `https://oak-dental.onrender.com/api/treatments/${treatmentId}` : 'https://oak-dental.onrender.com/api/treatments';
            const method = treatmentId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                    body: formData
                });
                const result = await response.json();
                if (response.ok) {
                    alert(treatmentId ? 'Treatment updated successfully.' : 'Treatment added successfully.');
                    clearTreatmentForm();
                    loadTreatments();
                } else {
                    alert(result.message || 'Failed to save treatment.');
                }
            } catch (error) {
                console.error('Error saving treatment:', error);
                alert('An error occurred while saving the treatment: ' + error.message);
            }
        });

        // Edit treatment
        async function editTreatment(id) {
            try {
                const response = await fetch('https://oak-dental.onrender.com/api/treatments');
                const treatments = await response.json();
                const treatment = treatments.find(t => t.id == id);
                if (treatment) {
                    document.getElementById('treatment-name').value = treatment.name || '';
                    document.getElementById('treatment-description').value = treatment.description || '';
                    document.getElementById('treatment-price').value = treatment.price || '';
                    document.getElementById('treatment-offer').value = treatment.offer || '';
                    document.getElementById('save-treatment').dataset.id = id;
                    document.getElementById('save-treatment').textContent = 'Update Treatment';
                }
            } catch (error) {
                console.error('Error loading treatment for edit:', error);
                alert('Failed to load treatment for editing: ' + error.message);
            }
        }

        // Delete treatment
        async function deleteTreatment(id) {
            if (!confirm('Are you sure you want to delete this treatment?')) return;
            try {
                const response = await fetch(`https://oak-dental.onrender.com/api/treatments/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const result = await response.json();
                if (response.ok) {
                    alert('Treatment deleted successfully.');
                    loadTreatments();
                } else {
                    alert(result.message || 'Failed to delete treatment.');
                }
            } catch (error) {
                console.error('Error deleting treatment:', error);
                alert('An error occurred while deleting the treatment: ' + error.message);
            }
        }

        // Clear treatment form
        function clearTreatmentForm() {
            document.getElementById('treatment-name').value = '';
            document.getElementById('treatment-description').value = '';
            document.getElementById('treatment-price').value = '';
            document.getElementById('treatment-offer').value = '';
            document.getElementById('treatment-photo').value = '';
            document.getElementById('treatment-video').value = '';
            document.getElementById('save-treatment').textContent = 'Save Treatment';
            delete document.getElementById('save-treatment').dataset.id;
        }
        document.getElementById('clear-treatment-form').addEventListener('click', clearTreatmentForm);

        // Load timings
        async function loadTimings() {
            try {
                const response = await fetch('https://oak-dental.onrender.com/api/timings');
                if (!response.ok) {
                    throw new Error('Failed to fetch timings.');
                }
                const timings = await response.json();
                const tableBody = document.getElementById('timings-table');
                tableBody.innerHTML = '';
                if (timings.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="3" class="text-center">No timings found.</td></tr>';
                    return;
                }
                timings.forEach(timing => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${timing.day || 'N/A'}</td>
                        <td>${timing.open_time || 'N/A'}</td>
                        <td>${timing.close_time || 'N/A'}</td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading timings:', error);
                alert('Failed to load timings: ' + error.message);
            }
        }

        // Update timing
        document.getElementById('update-timing').addEventListener('click', async () => {
            const day = document.getElementById('timing-day').value;
            const openHour = document.getElementById('open-hour').value;
            const openMinute = document.getElementById('open-minute').value;
            const openPeriod = document.getElementById('open-period').value;
            const closeHour = document.getElementById('close-hour').value;
            const closeMinute = document.getElementById('close-minute').value;
            const closePeriod = document.getElementById('close-period').value;

            if (!openHour || !openMinute || !closeHour || !closeMinute) {
                alert('Please provide both open and close times.');
                return;
            }

            const openTime = `${openHour}:${openMinute < 10 ? '0' + openMinute : openMinute} ${openPeriod}`;
            const closeTime = `${closeHour}:${closeMinute < 10 ? '0' + closeMinute : closeMinute} ${closePeriod}`;

            try {
                const response = await fetch(`https://oak-dental.onrender.com/api/timings/${day}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ open_time: openTime, close_time: closeTime })
                });
                const result = await response.json();
                if (response.ok) {
                    alert('Timing updated successfully.');
                    loadTimings();
                } else {
                    alert(result.message || 'Failed to update timing.');
                }
            } catch (error) {
                console.error('Error updating timing:', error);
                alert('An error occurred while updating the timing: ' + error.message);
            }
        });

        // Initial setup
        updateNavVisibility();
        if (localStorage.getItem('token')) {
            showSection('appointments');
            loadAppointments();
        } else {
            showSection('login');
        }
    </script>
</body>
</html>